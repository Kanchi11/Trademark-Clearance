name: Daily Trademark Sync

on:
  # Run daily at 3 AM UTC (10 PM EST previous day)
  schedule:
    - cron: '0 3 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync-daily:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Import yesterday's trademark applications
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Get yesterday's date (since today's file may not be ready yet)
          YESTERDAY=$(date -d yesterday +%y%m%d)

          # Try the new data.uspto.gov domain first
          URL="https://data.uspto.gov/bulkdata/trademark/dailyxml/TRTDXFAP/apc${YESTERDAY}.zip"

          echo "üì• Downloading daily trademark applications for $YESTERDAY..."
          echo "   URL: $URL"

          npm run data:import -- --url "$URL"

          echo "‚úÖ Import completed"

      - name: Verify import
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM uspto_trademarks;" 2>/dev/null || echo "0")
          echo "üìä Total trademarks in database: $COUNT"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è  Daily trademark sync failed"
          echo "Check: USPTO data server, network connectivity, and database connection"
          exit 1

  # Optional: Weekly verification that data is fresh
  verify-freshness:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0'
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Verify data freshness
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Check if we have data from the last 7 days
          RECENT_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM uspto_trademarks WHERE created_at > NOW() - INTERVAL '7 days';" 2>/dev/null || echo "0")
          TOTAL_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM uspto_trademarks;" 2>/dev/null || echo "0")

          echo "üìä Data freshness check:"
          echo "   Total trademarks: $TOTAL_COUNT"
          echo "   Last 7 days: $RECENT_COUNT"

          if [ "$TOTAL_COUNT" -lt 1000 ]; then
            echo "‚ö†Ô∏è  WARNING: Database has fewer than 1000 records"
            echo "   Consider running: npm run setup:annual"
            exit 1
          fi

